<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Mortgage Calculator Engine</title>
  </head>
  <body>
    <script type="module">
      (function () {
        const MONTHS_IN_YEAR = 12;
        const ZERO_TOLERANCE = 1e-8;

        const toNumber = (value) => {
          const num = Number(value);
          return Number.isFinite(num) ? num : 0;
        };

        const clampNonNegative = (value) => {
          const num = toNumber(value);
          return num < 0 ? 0 : num;
        };

        const normalizeMonth = (month) => {
          const m = Math.round(toNumber(month));
          if (Number.isNaN(m) || m <= 0) return 1;
          if (m > 12) {
            return ((m - 1) % 12) + 1;
          }
          return m;
        };

        const normalizeYear = (year) => {
          const y = Math.round(toNumber(year));
          return y > 0 ? y : new Date().getFullYear();
        };

        function compute_base_loan_amount(home_value, down_payment_value, down_payment_pct) {
          const hv = clampNonNegative(home_value);
          const dpValueInput = clampNonNegative(down_payment_value);
          const dpPctInput = clampNonNegative(down_payment_pct);

          let downPaymentValue = 0;
          if (dpValueInput > 0) {
            downPaymentValue = Math.min(dpValueInput, hv);
          } else if (dpPctInput > 0) {
            downPaymentValue = Math.min(hv * dpPctInput, hv);
          }

          const loan_amount_base = clampNonNegative(hv - downPaymentValue);
          const down_payment_pct_normalized = hv > 0 ? downPaymentValue / hv : 0;

          return {
            loan_amount_base,
            down_payment_value: downPaymentValue,
            down_payment_pct: down_payment_pct_normalized,
          };
        }

        function apply_upfront_fee(loan_amount_base, upfront_fee_pct, finance_upfront_fee) {
          const base = clampNonNegative(loan_amount_base);
          const feePct = clampNonNegative(upfront_fee_pct);
          const upfront_fee = base * feePct;
          const financed = Boolean(finance_upfront_fee);
          const principal_0 = financed ? base + upfront_fee : base;
          const cash_at_close_upfront_fee = financed ? 0 : upfront_fee;

          return {
            principal_0,
            upfront_fee,
            cash_at_close_upfront_fee,
          };
        }

        function normalize_property_tax(property_tax_input, home_value) {
          const hv = clampNonNegative(home_value);
          const input = clampNonNegative(property_tax_input);

          if (input <= 20) {
            return {
              property_tax_yearly: hv * (input / 100),
              property_tax_mode: "percent",
            };
          }

          return {
            property_tax_yearly: input,
            property_tax_mode: "absolute",
          };
        }

        function monthly_p_and_i(principal_0, rate_apr, term_years) {
          const principal = clampNonNegative(principal_0);
          const termYears = clampNonNegative(term_years);
          const n = Math.max(Math.round(termYears * MONTHS_IN_YEAR), 0);

          if (n === 0 || principal === 0) {
            return 0;
          }

          const yearlyRate = clampNonNegative(rate_apr);
          const i_m = yearlyRate / MONTHS_IN_YEAR;

          if (i_m === 0) {
            return principal / n;
          }

          const factor = Math.pow(1 + i_m, n);
          if (!Number.isFinite(factor) || Math.abs(factor - 1) < ZERO_TOLERANCE) {
            return principal / n;
          }

          return (principal * i_m * factor) / (factor - 1);
        }

        function monthly_mi_conventional(principal_t, home_value, pmi_pct) {
          const hv = clampNonNegative(home_value);
          if (hv === 0) {
            return 0;
          }

          const principal = clampNonNegative(principal_t);
          const ltv = principal / hv;
          if (ltv <= 0.8 + ZERO_TOLERANCE) {
            return 0;
          }

          return principal * (clampNonNegative(pmi_pct) / MONTHS_IN_YEAR);
        }

        function monthly_mi_fha(principal_t, annual_mi_pct) {
          return clampNonNegative(principal_t) * (clampNonNegative(annual_mi_pct) / MONTHS_IN_YEAR);
        }

        function monthly_mi_usda(principal_t, annual_mi_pct) {
          return clampNonNegative(principal_t) * (clampNonNegative(annual_mi_pct) / MONTHS_IN_YEAR);
        }

        function monthly_mi_va() {
          return 0;
        }

        const createStartDate = (start_month, start_year) =>
          new Date(normalizeYear(start_year), normalizeMonth(start_month) - 1, 1);

        const advanceOneMonth = (date) => new Date(date.getFullYear(), date.getMonth() + 1, 1);

        function amortize_monthly(
          principal_0,
          i_m,
          n,
          start_month,
          start_year,
          tax_monthly,
          ins_monthly,
          hoa_monthly,
          monthly_mi_fn,
          home_value,
          p_and_i,
          extra_principal_monthly = 0,
          extra_start_month_index = 0
        ) {
          const schedule = [];
          const totals = {
            interest: 0,
            tax: 0,
            ins: 0,
            hoa: 0,
            mi: 0,
            principal: 0,
            extra_principal: 0,
            payments: 0,
          };

          let principal = clampNonNegative(principal_0);
          let currentDate = createStartDate(start_month, start_year);
          const totalPeriods = Math.max(Math.round(toNumber(n)), 0);
          const extraStartIndex = Math.max(Math.round(toNumber(extra_start_month_index)), 0);
          const taxMonthly = clampNonNegative(tax_monthly);
          const insMonthly = clampNonNegative(ins_monthly);
          const hoaMonthly = clampNonNegative(hoa_monthly);
          const extraMonthly = clampNonNegative(extra_principal_monthly);

          for (let t = 0; t < totalPeriods && principal > ZERO_TOLERANCE; t += 1) {
            const interest = principal * clampNonNegative(i_m);
            const scheduledPrincipalCandidate = Math.max(p_and_i - interest, 0);
            const principal_scheduled = Math.min(scheduledPrincipalCandidate, principal);

            const wantsExtra = t >= extraStartIndex ? extraMonthly : 0;
            const extra_remaining_capacity = Math.max(principal - principal_scheduled, 0);
            const extra_principal = Math.min(wantsExtra, extra_remaining_capacity);

            const mi = clampNonNegative(monthly_mi_fn(principal, home_value));
            const tax = taxMonthly;
            const ins = insMonthly;
            const hoa = hoaMonthly;

            const principal_reduction = Math.min(principal_scheduled + extra_principal, principal);
            const actual_p_and_i = interest + Math.max(principal_reduction - extra_principal, 0);
            const total_payment = actual_p_and_i + mi + tax + ins + hoa + extra_principal;
            const closing_balance = clampNonNegative(principal - principal_reduction);

            totals.interest += interest;
            totals.tax += tax;
            totals.ins += ins;
            totals.hoa += hoa;
            totals.mi += mi;
            totals.principal += principal_reduction;
            totals.extra_principal += extra_principal;
            totals.payments += total_payment;

            schedule.push({
              index: t,
              date: {
                year: currentDate.getFullYear(),
                month: currentDate.getMonth() + 1,
              },
              opening_balance: principal,
              p_and_i: actual_p_and_i,
              interest,
              principal_scheduled: Math.max(principal_reduction - extra_principal, 0),
              extra_principal,
              mi,
              tax,
              ins,
              hoa,
              total_payment,
              closing_balance,
            });

            principal = closing_balance;
            currentDate = advanceOneMonth(currentDate);

            if (principal <= ZERO_TOLERANCE) {
              principal = 0;
              break;
            }
          }

          const payoff_date = schedule.length
            ? schedule[schedule.length - 1].date
            : {
                year: normalizeYear(start_year),
                month: normalizeMonth(start_month),
              };

          return { schedule, payoff_date, totals };
        }

        function summarize_outputs(schedule, totals) {
          return {
            total_interest: totals.interest,
            total_tax: totals.tax,
            total_ins: totals.ins,
            total_hoa: totals.hoa,
            total_mi: totals.mi,
            total_of_payments: totals.payments,
            total_principal: totals.principal,
            total_extra_principal: totals.extra_principal,
            payments_made: schedule.length,
          };
        }

        function calculate_mortgage(params) {
          const {
            loan_type,
            home_value,
            down_payment_value,
            down_payment_pct,
            rate_apr,
            term_years,
            start_month,
            start_year,
            property_tax_input,
            homeowners_insurance_yearly,
            hoa_monthly,
            upfront_fee_pct,
            annual_mi_pct,
            finance_upfront_fee,
            extra_principal_monthly,
            extra_start_month_index,
            pmi_pct,
          } = params;

          const baseLoan = compute_base_loan_amount(home_value, down_payment_value, down_payment_pct);
          const feeResult = apply_upfront_fee(
            baseLoan.loan_amount_base,
            clampNonNegative(upfront_fee_pct),
            finance_upfront_fee
          );
          const taxInfo = normalize_property_tax(property_tax_input, home_value);

          const tax_monthly = taxInfo.property_tax_yearly / MONTHS_IN_YEAR;
          const ins_monthly = clampNonNegative(homeowners_insurance_yearly) / MONTHS_IN_YEAR;
          const hoa = clampNonNegative(hoa_monthly);
          const n = Math.max(Math.round(clampNonNegative(term_years) * MONTHS_IN_YEAR), 0);
          const i_m = clampNonNegative(rate_apr) / MONTHS_IN_YEAR;
          const p_and_i = monthly_p_and_i(feeResult.principal_0, rate_apr, term_years);

          const loanType = typeof loan_type === "string" ? loan_type : "conventional";
          const pmiPct = clampNonNegative(pmi_pct);
          const annualMiPct = clampNonNegative(annual_mi_pct);

          let monthly_mi_fn;
          switch (loanType) {
            case "FHA":
              monthly_mi_fn = (principal) => monthly_mi_fha(principal, annualMiPct);
              break;
            case "VA":
              monthly_mi_fn = () => monthly_mi_va();
              break;
            case "USDA":
              monthly_mi_fn = (principal) => monthly_mi_usda(principal, annualMiPct);
              break;
            case "conventional":
            default:
              monthly_mi_fn = (principal, hv) => monthly_mi_conventional(principal, hv ?? home_value, pmiPct);
              break;
          }

          const amortization = amortize_monthly(
            feeResult.principal_0,
            i_m,
            n,
            start_month,
            start_year,
            tax_monthly,
            ins_monthly,
            hoa,
            (principal, hv) => monthly_mi_fn(principal, hv ?? home_value),
            home_value,
            p_and_i,
            extra_principal_monthly,
            extra_start_month_index
          );

          const totalsSummary = summarize_outputs(amortization.schedule, amortization.totals);
          const monthly_mi_initial = monthly_mi_fn(feeResult.principal_0, home_value);
          const total_monthly_0 =
            p_and_i + tax_monthly + ins_monthly + hoa + monthly_mi_initial;

          return {
            inputs: {
              loan_type: loanType,
              home_value: clampNonNegative(home_value),
              down_payment_value: baseLoan.down_payment_value,
              down_payment_pct: baseLoan.down_payment_pct,
              rate_apr: clampNonNegative(rate_apr),
              term_years: clampNonNegative(term_years),
              start_month: normalizeMonth(start_month),
              start_year: normalizeYear(start_year),
              property_tax_input: clampNonNegative(property_tax_input),
              homeowners_insurance_yearly: clampNonNegative(homeowners_insurance_yearly),
              hoa_monthly: hoa,
              upfront_fee_pct: clampNonNegative(upfront_fee_pct),
              annual_mi_pct: annualMiPct,
              finance_upfront_fee: Boolean(finance_upfront_fee),
              extra_principal_monthly: clampNonNegative(extra_principal_monthly),
              extra_start_month_index: Math.max(Math.round(toNumber(extra_start_month_index)), 0),
              pmi_pct: pmiPct,
            },
            derived: {
              loan_amount_base: baseLoan.loan_amount_base,
              principal_0: feeResult.principal_0,
              upfront_fee: feeResult.upfront_fee,
              cash_at_close_upfront_fee: feeResult.cash_at_close_upfront_fee,
              property_tax_yearly: taxInfo.property_tax_yearly,
              property_tax_mode: taxInfo.property_tax_mode,
              tax_monthly,
              ins_monthly,
              hoa_monthly: hoa,
              p_and_i,
              monthly_mi_initial,
              total_monthly_0,
            },
            payoff_date: amortization.payoff_date,
            totals: totalsSummary,
            schedule: amortization.schedule,
          };
        }

        const mortgageCalculator = Object.freeze({
          compute_base_loan_amount,
          apply_upfront_fee,
          normalize_property_tax,
          monthly_p_and_i,
          monthly_mi_conventional,
          monthly_mi_fha,
          monthly_mi_usda,
          monthly_mi_va,
          amortize_monthly,
          summarize_outputs,
          calculate_mortgage,
        });

        globalThis.mortgageCalculator = mortgageCalculator;
      })();
    </script>
  </body>
</html>
